function get_now_time(){var a=new Date,b=a.toLocaleString();tempTime=document.getElementById("nowTime").innerHTML=b}function sumAll(){0==x&&(startCount(),countAllSeconds(),x++)}function startCount(){window.clearInterval(interval_mark)}function countAllSeconds(){countNum+=1,seconds_=countNum,minutes_=countNum/60,hours_=countNum/3600,document.getElementById("countAllSeconds").innerHTML=hours_+"小时"+"<br/>"+minutes_+"分钟"+"<br/>"+seconds_+"秒",totalSeconds=hours_+"小时",countToggle=setTimeout("countAllSeconds()",1e3),flag=1}function continueCount(){0==flag&&countAllSeconds()}function loadDetails(a){var b=db.transaction("Data","readwrite"),c=b.objectStore("Data"),d=a.getAttribute("id"),e=c.get(d);e.onsuccess=function(){e.result&&($.mobile.changePage($("#details")),$("#detailsPlanName").html(e.result.planName),$("#detailsStartTime").html(e.result.startTime),$("#detailsPlanTime").html(e.result.planTime+"小时"),$("#detailsTotalTime").html(e.result.totalTime+"小时"))}}function listAll(){var a=db.transaction("Data","readwrite"),b=a.objectStore("Data"),c=b.openCursor(),d="";c.onsuccess=function(a){var c,b=a.target.result;b?(c=parseFloat(100*(b.value.totalTime/b.value.planTime)),d+="<li class='ui-li-has-alt ui-li-has-count ui-li-has-thumb ui-first-child ui-last-child'><a href='#'  id='"+b.key+"' class='ui-btn padding_left'  onClick='loadDetails(this)'><h2>"+b.key+"</h2><p>已坚持："+getTwoDecima(b.value.totalTime)+"小时</p><p>目标时间："+b.value.planTime+"小时</p><span class='ui-li-count ui-body-inherit'>"+getTwoDecima(c)+"%</span> </a><a href='#' data-icon='grid' class='info ui-btn ui-btn-icon-notext ui-icon-grid' id='fake"+b.key+"' onClick='loadRecord(this)'>打卡</a></li>",b.continue()):$("#liBox").html(d)}}function getTwoDecima(a){var b;return a=a.toString(),b=a.substring(0,a.indexOf(".")+3)}function showBtn(){var d,a=db.transaction("Data","readwrite"),b=a.objectStore("Data"),c=prompt("请输入要删除的计划名称！");null!=c&&(d=b.delete(c),d.onsuccess=function(){alert("操作成功！"),listAll()})}function addClick(a){var b=db.transaction("Data","readwrite");store=b.objectStore("Data"),request="add"==a?store.add({planName:$("#planName").val(),startTime:$("#startTime").val(),planTime:$("#planTime").val(),recordStartTime:$("#startTime").val(),recordStopTime:0,totalTime:0}):store.put({planName:$("#planName").val(),startTime:$("#startTime").val(),planTime:$("#planTime").val(),recordStartTime:$("#startTime").val(),recordStopTime:0,totalTime:0})}function confirm_q(a){var c,d,e,f,b=confirm("结束今天的学习了吗？");1==b?(alert("今天总共学习了"+totalSeconds+"\n开始时间："+startTime.value+"\n结束时间："+tempTime),c=db.transaction("Data","readwrite"),d=c.objectStore("Data"),e=a.parentNode.parentNode.childNodes[1].lastChild.innerHTML,f=d.get(e),f.onsuccess=function(){f.result&&(new_total_time=parseFloat(f.result.totalTime)+parseFloat(totalSeconds),d.put({planName:f.result.planName,startTime:f.result.startTime,planTime:f.result.planTime,recordStartTime:f.result.recordStartTime,recordStopTime:tempTime,totalTime:new_total_time}),window.location.reload())}):href="#"}function loadRecord(a){var b=db.transaction("Data","readwrite"),c=b.objectStore("Data"),d=a.getAttribute("id").substr(4),e=c.get(d);e.onsuccess=function(){e.result&&($.mobile.changePage($("#record")),$("#recordPlanName").html(e.result.planName))}}var interval_mark,x,countNum,countToggle,seconds_,flag;onload=function(){setInterval(function(){startTime.value=(new Date).toLocaleString()},1e3)},interval_mark=self.setInterval("get_now_time()",100),x=0,countNum=0,seconds_=0,flag=0,$(function(){window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.indexedDB||alert("该浏览器不支持IndexedDB，请更换浏览器");var a=window.indexedDB.open("Hours",1);a.onsuccess=function(){db=this.result,listAll()},a.onerror=function(a){alert("openDB:",a.target.errorCode)},a.onupgradeneeded=function(a){var b=a.target.result,c=b.createObjectStore("Data",{keyPath:"planName",autoIncrement:!0});c.createIndex("planName","planName",{unique:!1}),c.createIndex("planTime","planTime",{unique:!1}),c.createIndex("recordStartTime","recordStartTime",{unique:!1}),c.createIndex("recordStopTime","recordStopTime",{unique:!1}),c.createIndex("startTime","startTime",{unique:!1}),c.createIndex("totalTime","totalTime",{unique:!1})}}),$("#del").on("click",showBtn),$("#confirmBtn").click(function(){addClick("add"),listAll(),$.mobile.changePage($("#home"))}),$("#del_all_plan").click(function(){confirm("即将删除所有数据！")&&(window.indexedDB.deleteDatabase("Hours"),alert("删除成功！"),window.location.reload())});